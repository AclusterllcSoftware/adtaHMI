<%- include('header', {currentMenu: 'params', pageTitle: 'Parameters'}); %>
<div class="row mt-3">
    <div class="col-lg-12 text-center mb-4">
        <div class="px-1 py-2 border border-light" style="display: inline-block">
            <span class="mr-2 px-2" id="site_name"></span>
            <span class="mr-2 px-2 " id="machine_name"></span>
            <span id="install_date">Install Date: -</span>
        </div>
    </div>
    <div class="col-lg-12">
        <table class="table table-sm table-bordered table-striped">
            <thead>
            <tr>
                <th>Parameter ID</th>
                <th>Description</th>
                <th>Value</th>
                <th>Unit</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="table-parameters"></tbody>
        </table>
    </div>
</div>
</div>

<%- include('footer', {currentMenu: 'params'}); %>
<script src="js/jquery-bootstrap.js"></script>
<script src="js/jquery.newsTicker.js"></script>
<script src="js/daterangepicker/moment.min.js"></script>
<script src="js/nav.js"></script>

<script>
    let basic_info = {};

    jQuery(document).ready(function () {
        jQuery("#ip_list_dropdown").change(function () {
            selected_machine = jQuery(this).val();
            if (selected_machine !== "") {
                let selected_machine_name = machine_list[selected_machine];
                jQuery("#display_machine_name").text(selected_machine_name);
            } else {
                jQuery("#display_machine_name").text("Select a machine");
                selected_machine = 0;
            }
            ipcRenderer.send("get:views", selected_machine, "params");
            // setInterval(()=>{
            //     ipcRenderer.send("get:views", selected_machine, "params");
            // }, 60000)
        });
    });
    ipcRenderer.on("render:params", function (e, data) {
        let parameters = [], table_html = '', current_user = null, machine_info;
        basic_info = data;

        machine_info= basic_info['machinesInfo'][selected_machine];
        $('#site_name').text(machine_info['site_name']);
        $('#machine_name').text(machine_info['machine_name']);

        current_user = basic_info['currentUser'];
        parameters = Object.values(basic_info['parametersInfo']);
        parameters.forEach(i => {
            table_html +=
                "<tr>" +
                "<td>" +
                i.param_id +
                "</td>" +
                "<td>" +
                i.description +
                "</td>" +
                "<td data-id=" + i.param_id + " class='params-value'>" +
                i.value +
                "</td>" +
                "<td>" +
                i.unit +
                "</td>" +
                "<td>" +
                ((current_user.role == 1 || current_user.role == 2) ?
                        '<form class="d-flex form-params"> <input type="text" class="form-control" name="c_value"> ' +
                        '<input class="params-id" type="hidden" name="params_id" value='+ i.param_id +'>'+
                        '<button type="submit" class="btn btn-primary button_params" >Change</button> </form>' : ''
                )
                +
                "</td></tr>";
        });
        jQuery("#table-parameters").empty();
        jQuery("#table-parameters").append(table_html);
        // jQuery('.form-params>.params-id').each(function (index, element) {
        //     $(element).val(Number(parameters[index]['id']));
        // });
        $('.form-params').submit(function (e) {
            e.preventDefault();
            let inputValues = $(this).serializeArray();
            let param_id = null, new_value = null;

            inputValues.forEach(inpValue => {
                if (inpValue.name == 'c_value') {
                    new_value = Number(inpValue.value);
                }
                if (inpValue.name == 'params_id') {
                    param_id = Number(inpValue.value);
                }
            });

            ipcRenderer.send("sendRequest", selected_machine, 'sendSetParamMessage', {
                'paramId': param_id,
                'value': new_value
            });
        });
        ipcRenderer.send("sendRequest", selected_machine, 'getMaintViewData', {});
        setInterval(() => {
            ipcRenderer.send("sendRequest", selected_machine, 'getMaintViewData', {});
        }, 1000);
    });
    ipcRenderer.on("getMaintViewData", function (e, data) {
        console.log(data);
        let paramValues = Object.values(data['parameterValues']), allRows = [];
        console.log(paramValues);
        allRows = $('.params-value');
        $(allRows).each((key, elem) => {
            let rowId = $(elem)[0].dataset.id, paramData = paramValues.find(d => d.param_id == rowId);
            console.log(paramData);
            $(elem).text(paramData.value);
        })
        console.log();

    });
</script>
